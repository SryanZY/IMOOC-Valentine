<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>班级报告</title>
<!-- css文件 放头部-->
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/rep.css" />
<!-- 引入共有的css -->
<script src="js/style.js"></script>
</head>
<body>
	<div id="header"></div>
    <div id="main">
        <div class="wrapper_rep">
            <div class="logo_rep">
                <h1>大学生英语能力诊断测评系统</h1>
                <h3>单项技能诊断测试-听力</h3>
                <h3>班级诊断报告</h3>
            </div>
            <!--考生信息-->
            <div class="line_one">
                <table class="table table-bordered">
                    <tr>
                        <th>班级名称：</th>
                        <th>考试人数：</th>
                    </tr>
                    <tr>
                        <td>暑期培训班</td>
                        <td>14</td>
                    </tr>
                </table>
            </div>
            <!--考生信息 end-->
            
            <!--各级别人数占比-->
            <div class="line_one">
                <h3><span>各级别人数占比</span></h3>
                <div id="gradeRatioChart" style="min-width: 310px; height: 300px; max-width: 500px; margin: 0 auto"></div>
            </div>
            <!--各级别人数占比 end-->
            
            <!--级别对照表-->
            <div class="line_one">
                <h3><span>级别对照表</span></h3>
                <div id="gradeComparisonTable"></div>
            </div>
            <!--级别对照表 end-->
            
            <!--各级别听力微技能能力平均分-->
            <div class="line_one">
                <h3><span>各级别听力微技能能力平均分</span></h3>
                <div id="subskillAverageChart" style="min-width: 310px; height: 400px; max-width: 800px; margin: 0 auto"></div>
                <div id="subskillAverageTable"></div>
            </div>
            <!--各级别听力微技能能力平均分 end-->
            
            <!--班级听力微技能表现-->
            <div class="line_one">
                <h3><span>班级听力微技能表现</span></h3>
                <div id="subskillTable"></div>
            </div>
            <!--班级听力微技能表现 end-->
            
            <!--班级听力成长曲线-->
            <div class="line_one">
                <h3><span>班级听力成长曲线</span></h3>
                <div id="growthCurveChart" style="min-width: 310px; height: 300px; max-width: 700px; margin: 0 auto"></div>
            </div>
            <!--班级听力成长曲线 end-->
            
            <!--班级词汇量测试结果-->
            <div class="line_one">
                <h3><span>班级词汇量测试结果</span></h3>
                <div id="vocabularyChart" style="min-width: 310px; height: 400px; max-width: 700px; margin: 0 auto"></div>
            </div>
            <!--班级词汇量测试结果 end-->
            
        </div>
    </div>
	<div id="footer" style="text-align:center;"></div>
	
    <!-- js文件放底部 -->
    <!-- 共有的js引用commos.js -->
    <script src="js/common.js"></script>
    <script src="js/highcharts.js"></script>
    <!--  各个页面单独用的js 各自引入-->
    <script type="text/javascript">
    var clazzId = $.getUrlParam('clazzId') || 'c0d9c749-21bd-46f8-baca-f298206e8b96';
    var skill = $.getUrlParam('skill') || 'S1';
    var beginDate = $.getUrlParam('beginDate') || '2017-03-01';
    var endDate = $.getUrlParam('endDate') || '2017-08-31';
    $(function(){
    	$("#header").load("header.html");
    	$("#footer").load("footer.html");
        getReportInfo();
    });
    
    function getReportInfo() {
        $.ajax({
            type: "GET",
            url: serverUrl + 'reports/' + clazzId+"/"+skill+"/"+beginDate+"/"+endDate,
            beforeSend: $.beforeSend,
            aysnc: false,
            success: function (data) {
                console.log(data);
                if (data['status'] < 400) {
                    
	                renderGradeRatioResults(data['data']['gradeRatioResults']);
	                
	                renderGradeComparison();
	                
	                renderSubskillAverageResults(data['data']['subskillAverageResults']);
	                
	                renderSubSkillResults(data['data']['subskillResults']);
	                
	                renderGrowthCurveResults();
	                
	                renderVocabularyResults();
                }
                
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                gz.logger(textStatus);
                gz.logger(errorThrown);
            }
        });
    }
    
    
    function renderGradeRatioResults(results){
        Highcharts.chart('gradeRatioChart', {
            credits: {
                enabled: false
            },
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'pie'
            },
            title: {
                text: ''
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        distance: -50,
                        style: {
                            fontWeight: 'bold',
                            color: 'black'
                        },
                        formatter: function() {
                            return  this.point.name;
                        }
                     },
                    showInLegend: true
                }
            },
            legend:{
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle',
                margin:150,
                labelFormatter: function() {
                    return  this.name + ' : ' + this.y +"人";
                }
            },
            series: [{
                name: '占比',
                data: results
            }]
        });
    }
    
    function renderGradeComparison(){
        var gcDatas = [["5级","4","NCS8","B1"],
                       ["7级","5","CET4","B1+"],
                       ["9级","6","CET6/TEM4","B2"],
                       ["11级","7","TEM8","C1"]];
        $('#gradeComparisonTable').html(template('gradeComparison-template', {datas: gcDatas}));
    }
    
    function renderSubSkillResults(results){
        $('#subskillTable').html(template('subskill-template', {datas: results}));
    }
    
    function renderSubskillAverageResults(results){
        Highcharts.chart('subskillAverageChart', {
            credits: {
                enabled: false
            },
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            legend: {
                labelFormatter: function () {
                    return this.name;
                }
            },
            xAxis: {
                categories: results.categories,
                crosshair: true
            },
            yAxis: {
                min: 0,
                title: {
                    text: ''
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: results.series
        });
        
        $('#subskillAverageTable').html(template('subskillAverage-template', {datas: results}));
    }
    
    function renderGrowthCurveResults(results){
        Highcharts.chart('growthCurveChart', {
            credits: {
                enabled: false
            },
            legend: {
                enabled: false
             },
            chart:{
                zoomType: 'xy' //支持图表放大缩小的范围  
            },
            title:{
                text: ''
            },
            subtitle :{
                text: ''
            },
            plotOptions : {
                line: {
                   dataLabels: {
                      enabled: true,
                      formatter: function(){
                          return this.y
                      }
                   },
                   enableMouseTracking: false
                }
             },
            xAxis:{
                tickWidth:1, //刻度标签宽度
                gridLineWidth: 0, 
                tickmarkPlacement:'on',
                categories: ['2017.02', '2017.09', '2018.02']
            },
            yAxis:[{
                     lineWidth: 1,
                     tickWidth:1, //刻度标签宽度
                     tickmarkPlacement:'on',
                     gridLineWidth: 0,
                     categories: ['5级', '7级', '9级',"11级"],
                     title: {
                        text: 'FLTRP级别'
                     }
                }, { // Secondary yAxis
                    tickWidth:1, //刻度标签宽度
                    lineWidth: 1,
                    tickmarkPlacement:'on',
                    gridLineWidth: 0,
                    categories: ['B1', 'B1+', 'B2',"C1"],
                    title: {
                        text: 'CEFR级别'
                    },
                    opposite: true
                }, { // Tertiary yAxis
                    tickWidth:1, //刻度标签宽度
                    lineWidth: 1,
                    tickmarkPlacement:'on',
                    gridLineWidth: 0,
                    categories: ['4', '5', '6',"7"],
                    title: {
                        text: 'CSE级别'
                    },
                    opposite: true
            }],
            series:[{
                name:'FLTRP级别',
                data: [0, 3, 2]
            },{
                name:'CEFR级别',
                yAxis: 1,
                data: [0, 3, 2]
            },{
                name:'CSE级别',
                yAxis: 2,
                data: [0, 3, 2]
            }]
        });
    }
    
    function renderVocabularyResults(results){
        Highcharts.chart('vocabularyChart', {
            credits: {
                enabled: false
            },
            chart: {
                type: 'column'
            },
            title: {
                text: '班级词汇量人数分布'
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: true
                    }
                }
            },
            xAxis: {
                categories: ['1000', '2000', '3000', '4000', '5000', '6000', '7000', '8000', '8000以上']
            },
            yAxis: {
                lineWidth: 1,
                tickWidth: 1,
                gridLineWidth: 0,
                title: {
                    text: ''
                }
            },
            series: [{
                name:'词汇量',
                data: [1, 3, 5, 10, 16, 22, 4, 2, 1]
            }]
        });
    }
    </script>
    <script id="gradeComparison-template" type="text/html">
        <table class="table table-bordered">
            <tr>
                <th>FLTRP级别</th>
                <th>CSE级别</th>
                <th>国内水平考试</th>
                <th>CEFR级别</th>
            </tr>
            {{each datas as data i}}
            <tr>
                <td>{{data[0]}}</td>
                <td>{{data[1]}}</td>
                <td>{{data[2]}}</td>
                <td>{{data[3]}}</td>
            </tr>
            {{/each}}
        </table>
    </script>
    <script id="subskill-template" type="text/html">
        <table class="table table-bordered">
            <tr>
                <th style="width:100px;text-align: center;"></th>
                <th style="width:100px;text-align: center;">听力级别</th>
                <th style="width:100px;text-align: center;">听力总分</th>
                {{each datas.titles as title}}
                    <th style="width:100px;text-align: center;">{{title}}</th>
                {{/each}}
            </tr>
            {{each datas.results as data i}}
            <tr>
                <td style="text-align: center;">{{data.userName}}</td>
                <td style="text-align: center;">{{data.grade}}</td>
                <td style="text-align: center;">{{data.score}}</td>
                {{each data.subskills as subskill}}
                    <td style="text-align: center;">{{subskill.score}}</td>
                {{/each}}
            </tr>
            {{/each}}
        </table>
    </script>
     <script id="subskillAverage-template" type="text/html">
        <table class="table table-bordered">
            <tr>
                <th style="width:100px;text-align: center;"></th>
                {{each datas.categories as title}}
                    <th style="width:100px;text-align: center;">{{title}}</th>
                {{/each}}
            </tr>
            {{each datas.series as data}}
            <tr>
                <td style="text-align: center;">{{data.name}}</td>
                {{each data.data as val}}
                    <td style="text-align: center;">{{val}}</td>
                {{/each}}
            </tr>
            {{/each}}
        </table>
    </script>
</body>
</html>

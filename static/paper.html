<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>试卷管理</title>
<!-- css文件 放头部-->
<link rel="stylesheet" type="text/css" href="css/style.css" />

<!-- 引入共有的css -->
<script src="js/style.js"></script>
<link href="lib/uploader/zui.uploader.min.css" type="text/css" rel="stylesheet">
</head>
<body>
    <div id="header"></div>
    <div id="main">
        <div class="container">
            <ul class="nav nav-tabs">
                <li  class="active"><a href="###" data-target="#tab2Content1" data-toggle="tab">试卷管理</a></li>
                <li><a href="###" data-target="#tab2Content2" data-toggle="tab">试题管理</a></li>
                <li><a href="###" data-target="#tab2Content3" data-toggle="tab">试题导入</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade" id="tab2Content2">
                    <div class="container">
                        <div id="items-search" class="row" style="margin-top: 20px; margin-bottom: 20px;">
                            <div class="col-md-2">
                                <select id="s-task-skill" class="form-control" onchange="getTasks();">
                                   <option value="">全部技能</option>
                                   <option value="S0">词汇量</option>
                                   <option value="S1">听力</option>
                                   <option value="S2">阅读</option>
                                   <option value="S3">语言知识运用</option>
                                   <option value="S4">写作</option>
                                   <option value="S5">口语</option>
                                   <option value="S6">语法</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select id="s-task-level" class="form-control" onchange="getTasks();">
                                   <option value="">全部级别</option>
                                   <option value="5">5级</option>
                                   <option value="7">7级</option>
                                   <option value="9">9级</option>
                                   <option value="11">11级</option>
                               </select>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="icon icon-search"></i></span>
                                    <input type="text" class="form-control" placeholder="请输入名称" id="s-task-name" value="">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" onclick="getTasks();">搜索</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div id="items-data">
                            <table class="table table-hover" id="tasks-table" data-func="getTasks">
                               <thead>
                                 <tr>
                                    <th style="text-align: center;">序号</th>
                                    <th>名称<i class="sort-flag icon icon-sort icon-sort-up btn-link" data-sortkey="task_name"></i></th>
                                    <th style="text-align: center;">技能<i class="sort-flag icon icon-sort btn-link" data-sortkey="skill"></i></th>
                                    <th style="text-align: center;">级别<i class="sort-flag icon icon-sort btn-link" data-sortkey="task_level"></i></th>
                                    <th style="text-align: center;">难度</th>
                                    <th style="text-align: center;">推荐组</th>
                                    <th style="text-align: center;">来源</th>
                                    <th style="text-align: center;">练习题数目<i class="sort-flag icon icon-sort btn-link" data-sortkey="item_count"></i></th>
                                    <th style="text-align: center;">是否可用</th>
                                    <th style="text-align: center;width:6%;">操作</th>
                                 </tr>
                               </thead>
                               <tbody id="tasks"></tbody>
                          </table>
                          <div style="width:90%; margin:auto;"><div id="kkpager"></div></div>
                        </div>
                    </div>
                </div>
                
                 <div class="tab-pane fade active in" id="tab2Content1">
                    <div class="container">
                        <div id="papers-search" class="row" style="margin-top: 20px; margin-bottom: 20px;">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="icon icon-search"></i></span>
                                    <input type="text" class="form-control" placeholder="请输入名称" id="s-paper-name" value="">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" onclick="getPapers();">搜索</button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-1">
                              <button class="btn btn-success" type="button" onclick="showPaperModal(-1);">创建试卷</button>
                            </div>
                        </div>
                        <div id="papers-data">
                          <table class="table table-hover" id="papers-table" data-func="getPapers">
                           <thead>
                             <tr>
                                <th style="text-align: center;width:4%;">序号</th>
                                <th style="width:10%;">名称<i class="sort-flag icon icon-sort icon-sort-up btn-link" data-sortkey="paper_name"></i></th>
                                <th style="text-align: center;width:6%;">技能<i class="sort-flag icon icon-sort btn-link" data-sortkey="paper_skill"></i></th>
                                <th style="text-align: center;width:6%;">适用等级<i class="sort-flag icon icon-sort btn-link" data-sortkey="applicable_grade"></i></th>
                                <th style="width:10%;">描述</th>
                                <th style="width:6%;">试卷类型<i class="sort-flag icon icon-sort btn-link" data-sortkey="type" data-func="getPapers"></i></th>
                                <th style="text-align: center;width:6%;">试卷时长(秒)<i class="sort-flag icon icon-sort btn-link" data-sortkey="duration"></i></th>
                                <th style="text-align: center;width:6%;">试卷状态<i class="sort-flag icon icon-sort btn-link" data-sortkey="paper_status"></i></th>
                                <th style="text-align: center;width:6%;">操作</th>
                             </tr>
                           </thead>
                           <tbody id="papers"></tbody>
                         </table>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="tab2Content3">
                    <div class="alert alert-success with-icon alert-dismissable">
                        <i class="icon icon-info-sign"></i>
                        <div class="content"><h4>要导入文件格式：</h4><hr>
                            <ul>
                                <li>从题库系统导出的zip文件</li>
                                <li>可以整卷导入</li>
                                <li>可以题目批量导入</li>
                            </ul>
                        </div>
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                    </div>
                    <div id="uploaderFile" class="uploader">
                        <div class="uploader-message text-center">
                            <div class="content"></div>
                            <button type="button" class="close">×</button>
                        </div>
                        <div class="uploader-files file-list file-list-lg" data-drag-placeholder="请拖拽文件到此处"></div>
                        <div class="uploader-actions">
                            <div class="uploader-status pull-right text-muted"></div>
                            <button type="button" class="btn btn-link uploader-btn-browse"><i class="icon icon-plus"></i> 选择文件</button>
                            <button type="button" class="btn btn-link uploader-btn-start" id="uploadBtn"><i class="icon icon-cloud-upload"></i> 导入</button>
                        </div>
                    </div>
                    <div id="messages" class="alert alert-danger hide"></div>
                </div>
            </div>
            
            <!-- 添加、修改试卷信息 对话框HTML -->
            <div class="modal fade" id="paperModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span aria-hidden="true">×</span><span class="sr-only">关闭</span>
                            </button>
                            <h4 class="modal-title">试卷信息</h4>
                        </div>
                        <div class="modal-body">
                            <form id="paper-form" class="form-horizontal">
                                <input type="hidden" id="paperId" name="paperId" value="">
                                <div class="form-group">
                                    <label for="paperName" class="col-sm-3 control-label required">名称</label>
    
                                    <div class="col-sm-8">
                                        <input class="form-control" maxlength="256" type="text" id="paperName" name="paperName" value="">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="paperSkill" class="col-sm-3 control-label required">技能</label>
    
                                    <div class="col-sm-8">
                                         <select id="paperSkill" name="paperSkill" class="form-control">
                                            <option value="S0">词汇量</option>
                                            <option value="S1">听力</option>
                                            <option value="S2">阅读</option>
                                            <option value="S3">语言知识运用</option>
                                            <option value="S4">写作</option>
                                            <option value="S5">口语</option>
                                            <option value="S6">语法</option>
                                         </select>
                                    </div>
                                </div>    
                                <div class="form-group">
                                    <label for="applicableGrade" class="col-sm-3 control-label required">适用级别</label>
                                    
                                    <div class="col-sm-8">
                                        <select id="applicableGrade" name="applicableGrade" class="form-control">
                                            <option value="5">5级</option>
                                            <option value="7">7级</option>
                                            <option value="9">9级</option>
                                            <option value="11">11级</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="type" class="col-sm-3 control-label required">试卷类型</label>
    
                                    <div class="col-sm-8">
                                        <select id="type" name="type" class="form-control">
                                            <option value="0">试测卷</option>
                                            <option value="4">初次定级卷</option>
                                            <option value="5">诊断测试卷</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="paperDescription" class="col-sm-3 control-label">描述</label>
    
                                    <div class="col-sm-8">
                                        <textarea class="form-control" rows="3" maxlength="512" id="paperDescription" name="paperDescription"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="status" class="col-sm-3 control-label required">试卷状态</label>
    
                                    <div class="col-sm-8">
                                        <select id="status" name="status" class="form-control">
                                            <option value="0">备用</option>
                                            <option value="1">使用</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="duration" class="col-sm-3 control-label required">考试时长（秒）</label>
    
                                    <div class="col-sm-8">
                                        <input class="form-control" type="number" id="duration" name="duration" value="">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" onclick="savePaper();">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="footer" class="text-center"></div>

    <!-- js文件放底部 -->
    <!-- 共有的js引用commos.js -->
    <script src="js/common.js"></script>
    <!--  各个页面单独用的js 各自引入-->
    <script src="lib/uploader/zui.uploader.min.js" type="text/javascript"></script>
    <script src="js/sort_listener_events.js" type="text/javascript"></script>
    <script id="papers-template" type="text/html">
     {{if papers!=null && papers.length>0}}
        {{each papers as paper i}}
        <tr>
           <td style="text-align: center;">{{i+1}}</td>
           <td><a href="paper-preview.html?id={{paper.paperId}}&f=p" title="试卷预览" target="_blank">{{paper.paperName}}</a></td>
           <td style="text-align: center;">{{getSkillLabel(paper.paperSkill)}}</td>
           <td style="text-align: center;">{{getPaperGradeLabel(paper.applicableGrade)}}</td>
           <td>{{paper.paperDescription}}</td>
           <td>{{getPaperTypeLabel(paper.type)}}</td>
           <td style="text-align: center;">{{paper.duration}}</td>
           <td style="text-align: center;">{{getPaperStatusLabel(paper.status)}}</td>
           <td style="text-align: center;">
              <a href="paper-preview.html?id={{paper.paperId}}&f=p" title="预览" target="_blank"><i class="icon icon-file-powerpoint"></i></a>&nbsp;
              <a href="javascript:showPaperModal('{{i}}');" title="编辑"><i class="icon icon-edit"></i></a>&nbsp;
              <a href="javascript:deletePaper('{{paper.paperId}}');" title="删除"><i class="icon icon-trash"></i></a>
           </td>
        </tr>
        {{/each}}
    {{else}}
       <tr><td colspan="9" style="text-align: center;" class="danger">对不起！没有找到您要的数据。</td></tr>
    {{/if}}
    </script>
    <script id="tasks-template" type="text/html">
     {{if tasks!=null && tasks.length>0}}
        {{each tasks as task i}}
        <tr>
           <td style="text-align: center;">{{task.order}}</td>
           <td><a href="paper-preview.html?id={{task.taskId}}&f=t" title="预览" target="_blank">{{task.taskName}}</a></td>
           <td style="text-align: center;">{{getSkillLabel(task.skill)}}</td>
           <td style="text-align: center;">{{getPaperGradeLabel(task.level)}}</td>
           <td style="text-align: center;">{{task.difficulty}}</td>
           <td style="text-align: center;">{{task.group}}</td>
           <td style="text-align: center;">{{task.source}}</td>
           <td style="text-align: center;">{{task.itemCount}}</td>
           <td style="text-align: center;">{{getUseableLabel(task.useable)}}</td>
           <td style="text-align: center;">
              <a href="paper-preview.html?id={{task.taskId}}&f=t" title="预览" target="_blank"><i class="icon icon-file-powerpoint"></i></a>&nbsp;
           </td>
        </tr>
        {{/each}}
    {{else}}
       <tr><td colspan="10" style="text-align: center;" class="danger">对不起！没有找到您要的数据。</td></tr>
    {{/if}}
    </script>
    <script type="text/javascript">
        var fileTemplate ='<div class="file"><div class="file-progress-bar"></div>'
                +'<div class="file-wrapper"><div class="file-icon"><i class="icon icon-file-o"></i></div>'
                +'<div class="content"><div class="file-name"></div><div class="file-size small text-muted">0KB</div></div>'
                +'<div class="actions"><div class="file-status" data-toggle="tooltip"><i class="icon"></i> <span class="text"></span></div>'
                +'<a data-toggle="tooltip" class="btn btn-link btn-download-file" target="_blank"><i class="icon icon-download-alt"></i></a>'
                +'<button type="button" data-toggle="tooltip" class="btn btn-link btn-reset-file" title="Repeat"><i class="icon icon-repeat"></i></button>'
                +'<button type="button" data-toggle="tooltip" class="btn btn-link btn-rename-file" title="Rename"><i class="icon icon-pencil"></i></button>'
                +'<button type="button" data-toggle="tooltip" title="Remove" class="btn btn-link btn-delete-file"><i class="icon icon-trash text-danger"></i></button>'
                +'</div></div></div>';
        var uploaderOptions = {
            url : serverUrl + 'papers/tasks?userId='+$.cookie(cookieUserIdKey)+"&token="+$.cookie(cookieTokenKey),
            file_data_name : 'file',
            limitFilesCount : false,
            multi_selection : true,
            autoUpload : false,
            rename: true,
            fileTemplate: fileTemplate,
            removeUploaded: true,
            filters : {
                mime_types : [ {
                    title : 'zip',
                    extensions : 'zip'
                } ],
                max_file_size : '100mb',
                prevent_duplicates : false// 允许上传重复文件
            },
            chunk_size: 0, // 分片上传大小 默认 1mb;如果为 0，则表示不启用分片上传。
            max_retries: 0, // 当上传失败时的最大尝试次数，默认为3次，如果为 0 表示不重试。
            deleteConfirm: true,

            responseHandler : function(responseObject, file) {
                $("#messages").show();
                var result = JSON.parse(responseObject.response);
                console.log(result);
                if (result.status != 200) {
                    $("#messages").html('');
                    $.each( result.data, function(i, n){
                        $("#messages").append(n+"<br>");
                    });
                    return '上传失败。服务器返回了一个错误：' + result.msg;
                }else{
                    $("#messages").html(result.msg);
                }
            },
            onInit:function(){
                $("#messages").html('');
                $(".uploader .uploader-files").html('');
                $(".uploader .content").html('');
                $("#messages").hide();
            },
            onFilesRemoved:function(){
                $("#messages").html('');
                $("#messages").hide();
            }
        };

        function doUpload(){
            // 1. 获取 uploader 实例对象
            var uploader = $('#uploaderFile').data('zui.uploader');
            // 2. 调用 start 方法
            uploader.start();
        }

        $(function() {
            document.title = gz.global.title;
            $('#header').load('header.html');
            $('#footer').load('footer.html');

            $('#uploaderFile').uploader(uploaderOptions);

            $('#uploadBtn').on('click', function(){
               doUpload();
            });
            
            getPapers();
        });
        template.helper('getSkillLabel', gz.getSkillLabel);
        template.helper('getPaperTypeLabel', function(type){
            if (type == 0) {
                return "试测卷";
            }else if(type == 4){
                return "初次定级卷";
            }else if(type == 5){
                return "诊断定级卷";
            }
        });
        template.helper('getPaperStatusLabel', function(status){
            if (status == 0) {
                return "备用";
            }else if(status == 1){
                return "使用";
            }
        });
        template.helper('getPaperGradeLabel', function(grade){
            if(typeof(grade) != "undefined" && grade != ""){
                return grade+"级";
            }else{
                return "";
            }
        });
        template.helper('getUseableLabel', function(flag){
            if (flag == "f") {
                return "否";
            }else if(flag == "t"){
                return "是";
            }else{
                return "";
            }
        });
        
        var papers;
        function getPapers(){
            var sortKey = $("table#papers-table").data("sortkey");
            var sortType = $("table#papers-table").data("sorttype");
            $.ajax({
                type: "GET",
                data:{paperName:$.trim($('#s-paper-name').val()),
                      sortKey: sortKey,
                      sortType: sortType},
                url: serverUrl+'papers',
                beforeSend: $.beforeSend,
                success: function (data) {
                   if (data['status'] < 400) {
                       papers = data['data']['list'];
                      $('#papers').html(template('papers-template', {papers: papers}));
                   }else{
                       new $.zui.Messager('获取试卷列表失败', zuiMessager.fail).show();
                   }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
        
        <!--显示试卷信息的操作窗口-->
        function showPaperModal(index) {
            $('#paperModal').modal('show');
            document.getElementById('paper-form').reset();
            if (index === -1) {//新增
                $('#paperId').val('');
            } else {
                $('#paperId').val(papers[index]['paperId']);
                $('#paperName').val(papers[index]['paperName']);
                $('#paperSkill').val(papers[index]['paperSkill']);
                $('#applicableGrade').val(papers[index]['applicableGrade']);
                $('#type').val(papers[index]['type']);
                $('#paperDescription').val(papers[index]['paperDescription']);
                $('#status').val(papers[index]['status']);
                $('#duration').val(papers[index]['duration']);
            }
        }
        
        function savePaper(){
            if (!$.trim($('#paperName').val())) {
                new $.zui.Messager('请填写名称！', zuiMessager.fail).show();
                $('#paperName').focus();
                return;
            }
            if (!$.trim($('#paperSkill option:selected').val())) {
                new $.zui.Messager('请选择技能！', zuiMessager.fail).show();
                $('#paperSkill').focus();
                return;
            }
            if (!$.trim($('#applicableGrade option:selected').val())) {
                new $.zui.Messager('请选择适用级别！', zuiMessager.fail).show();
                $('#applicableGrade').focus();
                return;
            }
            if (!$.trim($('#type option:selected').val())) {
                new $.zui.Messager('请选择试卷类型！', zuiMessager.fail).show();
                $('#type').focus();
                return;
            }
            if (!$.trim($('#status option:selected').val())) {
                new $.zui.Messager('请选择试卷状态！', zuiMessager.fail).show();
                $('#status').focus();
                return;
            }
            if (!$.trim($('#duration').val())) {
                new $.zui.Messager('请填写考试时长！', zuiMessager.fail).show();
                $('#duration').focus();
                return;
            }
            var typeParam;
            var urlParam;
            var message;
            if (!$('#paperId').val()) {
                typeParam = 'POST';
                urlParam = 'papers';
                message = '创建';
            } else {
                typeParam = 'PUT';
                urlParam = 'papers/' + $('#paperId').val();
                message = '修改';
            }
            $.ajax({
                type: typeParam,
                url: serverUrl+urlParam,
                data: JSON.stringify($('#paper-form').serializeObject()),
                contentType:"application/json",
                dataType: 'json',
                async: true,
                beforeSend: $.beforeSend,
                success: function (data) {
                    if (data['status'] < 400) {
                        $('#paperModal').modal('hide');
                        new $.zui.Messager(message+'试卷成功',zuiMessager.success ).show();
                        getPapers();
                    } else {
                        new $.zui.Messager(message+'试卷失败', zuiMessager.fail).show();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
        
        <!--删除试卷信息-->
        function deletePaper(id){
            bootbox.confirm('确认删除该试卷吗？', function(result){
                if(result){
                    $.ajax({
                        type: 'DELETE',
                        url: serverUrl+'papers/' + id,
                        async: true,
                        beforeSend: $.beforeSend,
                        success: function (data) {
                            if (data['status'] < 400) {
                                getPapers();
                                new $.zui.Messager('删除试卷成功', zuiMessager.success).show();
                            } else {
                                new $.zui.Messager('删除试卷失败', zuiMessager.fail).show();
                            }
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            gz.logger(textStatus);
                            gz.logger(errorThrown);
                        }
                    });
                }else{
                    return;
                }
            });
        }
        
        var tasks;
        function getTasks(n,size){
            var pageNo = 1;
            if(typeof(n) != "undefined" && n != null){
                pageNo = n;
            }
            var pageSize = gz.defaultPageSize;
            if(typeof(size) != "undefined" && size != null){
                pageSize = size;
            }
            var sortKey = $("table#tasks-table").data("sortkey");
            var sortType = $("table#tasks-table").data("sorttype");
            $.ajax({
                type: "GET",
                data:{taskName:$.trim($('#s-task-name').val()),
                      skill:$.trim($('#s-task-skill option:selected').val()),
                      level:$.trim($('#s-task-level option:selected').val()),
                      pageNo:pageNo,
                      pageSize:pageSize,
                      sortKey: sortKey,
                      sortType: sortType},
                url: serverUrl+'tasks',
                beforeSend: $.beforeSend,
                success: function (data) {
                   if (data['status'] < 400) {
                       tasks = data['data']['list'];
                      $('#tasks').html(template('tasks-template', {tasks: tasks}));
                      //分页控件
                      var totalRecords = data['data']['count'];
                      initPage(pageNo, totalRecords, pageSize, getTasks);
                   }else{
                       new $.zui.Messager('获取试题列表失败', zuiMessager.fail).show();
                   }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
        
        $("a[data-target='#tab2Content1']").click(function(){
            getPapers();
        });
        $("a[data-target='#tab2Content2']").click(function(){
            getTasks();
        });
        $("a[data-target='#tab2Content3']").click(function(){
        });

    </script>
</body>
</html>

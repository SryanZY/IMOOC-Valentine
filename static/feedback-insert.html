<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>意见反馈</title>
<!-- css文件 放头部-->
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link href="lib/kindeditor/kindeditor.min.css" type="text/css" rel="stylesheet">
<link href="lib/uploader/zui.uploader.min.css" rel="stylesheet">
<style type="text/css">
    .icon-edit:before{
        margin-left: 90px;
    }
    
    .icon-info-sign:before {
        margin-left: 120px;
    }
    
    .icon-asterisk{
        color: red;
        margin-right: 5px;
    }
    
    .icon-asterisk:before{
        font-size: 10px;
    }
    
    .warn{
        color: red;
    }
</style>
<!-- 引入共有的css -->
<script src="js/style.js"></script>

</head>
<body>
    <div id="header"></div>
    <div id="main" style="width: 70%; margin-left: 15%;">
        <div id="feedback-container">
            <form id="feedback-insert-form" class="form-horizontal" action="javascript:uploaderImgs()">
                <div class="form-group">
                    <i class="icon icon-edit icon-4x col-sm-2"></i>
                    <div class="col-sm-10" style="border-bottom: 1px solid; padding-top: 5px; border-bottom-color: #cccccc; height: 48px;">
                         <span style="font-weight: bold; font-size: 24px;">意见反馈</span>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 30px;">
                    <div class="col-sm-10 col-sm-offset-2" style="background: #FFF9E5; padding-top: 10px; height: 70px;">
                         <span style="font-size: 16px;">反馈须知：如果您在使用产品时遇到问题，或者对我们有任何意见建议，欢迎在此留言，我们会用心倾听您的建议。</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="col-sm-2 control-label"><i class="icon-asterisk"></i>类型：</label>
                    <div class="col-sm-8 btn-group">
                        <button id="product" type="button" class="btn" style="margin-right: 12px;" onclick="chooseType('product')" value='1'>产品界面</button>
                        <button id="function" type="button" class="btn" style="margin-right: 12px;" onclick="chooseType('function')" value='2'>产品功能</button>
                        <button id="quality" type="button" class="btn" style="margin-right: 12px;" onclick="chooseType('quality')" value='3'>试题质量</button>
                        <button id="reports" type="button" class="btn" style="margin-right: 12px;" onclick="chooseType('reports')" value='4'>诊断报告</button>
                        <button id="others" type="button" class="btn" onclick="chooseType('others')" value='5'>其他建议</button>
                    </div>
                    <span id="type-warn" class="col-sm-2 warn" hidden><i class="icon icon-times"></i>请选择类型</span>
                </div>
            
                <div class="form-group">
                    <label for="feedback-title" class="col-sm-2 control-label">标题：</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" id="feedback-title">
                    </div>
                    <span id="title-warn" class="col-sm-2 warn" hidden><i class="icon icon-times"></i>请填写标题</span>
                </div>
                
                <div class="form-group">
                    <label for="feedback-content" class="col-sm-2 control-label"><i class="icon-asterisk"></i>内容：</label>
                    <div class="col-sm-8">
                        <textarea id="feedback-content" class="form-control kindeditor" style="width:100%; height:200px; visibility:hidden;">
                        </textarea>
                    </div>
                    <span id="content-warn" class="col-sm-2 warn" hidden><i class="icon icon-times"></i>请填写内容</span>
                </div>
                
                <div id="img-container" class="form-group">
                    <div id="uploader-img" class="uploader">
                        <div>
                            <label style="margin-left: 90px;">上传图片</label>
                            <button type="button" class="btn btn-default uploader-btn-browse" style="margin-left: 25px;"><i class="icon icon-plus"></i> 选择文件</button>
                         </div>
                        <div class="uploader-message text-center">
                            <div class="content"></div>
                            <button type="button" class="close">×</button>
                        </div>
                        <div class="uploader-files file-list file-list-grid" style="margin-left: 150px; margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="submit" class="btn btn-primary">提交反馈</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
     <!-- js文件放底部 -->
    <!-- 共有的js引用commos.js -->
    <script src="js/common.js"></script>
    <!--  各个页面单独用的js 各自引入-->
    <script src="lib/kindeditor/kindeditor.min.js"></script>
    <script src="lib/uploader/zui.uploader.min.js"></script>
    
    <script type="text/javascript">
        var uploader;
        var uploadImgsResult = true;
        var imgUrl = [];
        
        var uploaderOptions = {
            url : 'feedbacks/imgs?userId='+$.cookie(cookieUserIdKey)+"&token="+$.cookie(cookieTokenKey),
            file_data_name : 'file',
            multi_selection : false,
            autoUpload : false,
            rename : true,
            renameExtension : false,
            removeUploaded : true,
            filters : {
                mime_types : [ {
                    title : '图片',
                    extensions : 'jpg,gif,png'
                } ],
                prevent_duplicates : false// 允许上传重复文件
            },
            responseHandler : function(responseObject, file) {
                var result = JSON.parse(responseObject.response);
                if(result.status == 200) {
                    imgUrl.push(result.data);
                }else {
                    uploadImgsResult = false;
                    return result.msg;
                }
            },
            onUploadComplete : function(files) { //上传完成后执行
                if(uploadImgsResult) { //所有文件上传成功
                    for(var i = 0; i < uploader.getFiles().length; i++) { // 删除已上传的文件列表
                        uploader.removeFile(uploader.getFiles()[i]);
                    }
                    saveFeedback();
                }
            }
        };
    
        $(function(){
            $('#header').load('header.html');
            $('#footer').load('footer.html');
            KindEditor.ready(function(K) {
                editor = K.create('#feedback-content', {
                    basePath: 'lib/kindeditor/',
                    allowFileManager : true,
                    bodyClass : 'article-content',
                    items : [
                             'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline',
                             'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
                             'insertunorderedlist', '|', 'emoticons'],
                    //编辑器失去焦点(blur)时执行的回调函数
                    afterBlur : function() {
                        this.sync();
                    }
                });
            });
            
            //初始化图片上传
            $('#uploader-img').uploader(uploaderOptions);
            // 1. 获取 uploader 实例对象
            uploader = $('#uploader-img').data('zui.uploader');
        });
        
        function chooseType(type) {
            $(".btn-group .btn").each(function(){
                $(this).removeClass('active btn-primary');
            });
            $('#'+type).addClass('active btn-primary');
        }
        
        function uploaderImgs() {
            if(init()) { //验证通过
                if(uploader.getFiles().length > 0) { //有待上传文件
                     uploader.start();
                 }else{
                     saveFeedback();
                 }
            }
        }
        
        function init(){
            var content = editor.html();
            var type = $(".active").attr('value');
            if(typeof type == 'undefined') {
                $("#type-warn").show();
            }else {
                $("#type-warn").hide();
            }
            
            if(content == '') {
                $("#content-warn").show();
            }else {
                $("#content-warn").hide();
            }
            
            if(typeof type == 'undefined' || content == '') {
                return false;
            }else {
                return true;
            }
        }
        
        function saveFeedback() {
            dataMap = {
                'feedbackTitle' : $("#feedback-title").val(),
                'feedbackContent' : content = editor.html(),
                'feedbackType' : $(".active").attr('value'),
                'imgUrl' : imgUrl
            }
            
            $.ajax({
                type: 'POST',
                url: serverUrl + 'feedbacks',
                data: JSON.stringify(dataMap),
                contentType:"application/json",
                dataType: 'json',
                async: true,
                beforeSend: $.beforeSend,
                success:function(data){
                    if (data['status'] < 400) {
                        $(".btn-group .btn").each(function(){
                            $(this).removeClass('active btn-primary');
                        });
                        $("#feedback-title").val('');
                        editor.text('');
                        
                        imgUrl = [];
                        
                        new $.zui.Messager('意见反馈成功！', zuiMessager.success).show();
                    } else {
                        new $.zui.Messager('意见反馈失败！', zuiMessager.fail).show();
                    }
                },
                 error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
    </script>
</body>
</html>
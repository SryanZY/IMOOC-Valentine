<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>自我评价</title>
<!-- css文件 放头部-->
<link rel="stylesheet" type="text/css" href="css/style.css" />

<!-- 引入共有的css -->
<script src="js/style.js"></script>
</head>
<body>
    <div id="header"></div>
    <div id="main">
        <div id="evaluationTable" class="container"></div>
        <div class="text-center">
            <a id="submitBtn" type="button" class="btn btn-primary" >提交</a>
        </div>
    </div>
    <div id="footer" class="text-center"></div>

    <!-- js文件放底部 -->
    <!-- 共有的js引用commos.js -->
    <script src="js/common.js"></script>
    <!--  各个页面单独用的js 各自引入-->
    <script src="js/listening_self_evaluation.js"></script>
    <script src="js/reading_self_evaluation.js"></script>
        <script id="question-template" type="text/html">
            <div class="row text-center"><h2>{{title}}</h2></div>
            <div class="row"><h4 id="description">{{description}}</h4></div>
            <div class="row">
                <table class="table table-bordered table-hover">
                    <thead>
                    <tr>
                        <th>描述语</th>
                        {{each choices}}
                        <th>{{choices[$index]}}</th>
                        {{/each}}
                    </tr>
                    </thead>
                    <tbody>
                    {{each questions as question index}}
                    <tr id="row-{{index+1}}">
                        <td>{{index + 1}}. {{question.stem}}</td>
                        {{ each [1,2,3,4] as item}}
                        <td title="{{choices[item]}}"><input type="radio" name="{{id}}-{{index + 1}}" value="{{item}}"></td>
                        {{/each}}
                    </tr>
                    {{/each}}
                    <tr>
                </table>
            </div>
        </script>
    <script type="text/javascript">

    var userId = $.cookie(cookieUserIdKey);
    var examId = $.getUrlParam('examId');
    var skill = $.getUrlParam('skill');
    var evaluation_data = {};
    $(function(){
        $('#header').load('header.html');
        $('#footer').load('footer.html');
        document.title = gz.global.user_self_evaluation;
        if(skill == 'S1'){ // 听力自评
            evaluation_data = listening_self_evaluation;
        }else if(skill == 'S2' ){
            evaluation_data = reading_self_evaluation;
        }
        renderQuestionTable(evaluation_data);

        $('#submitBtn').on('click', function(){
            submitQs();
        });
    });
    
    function renderQuestionTable(data) {
        $('#evaluationTable').html(template('question-template', data));
    }
    
    function submitQs() {
        var answer = {};
        var notItem = [];
        var pref = evaluation_data['id'];
        for (var i = 0; i < evaluation_data['questions'].length; i++) {
            var question = evaluation_data['questions'][i];
            var rowNum = question['id'];
            var inputName = pref + "-" + rowNum;
            $('#row-'+ rowNum).removeClass('hl-danger');
            var v;
            if ($('input[type="radio"][name="' + inputName + '"]').size() > 0) {
                v = $('input[type="radio"][name="' + inputName + '"]:checked').val();
                if (!v) {
                    v = $('input[type="text"][name="' + inputName + '"]').val();
                }
            } 
            var tempArr = [];
            if (!v) {
                notItem.push(rowNum);
            }else{
                tempArr.push(v);
                answer[inputName] = tempArr;
            }
        }
        $.each(notItem, function(i, n){
            $('#row-'+ n).addClass('hl-danger');
        });
        if(notItem.length > 0) {
            new $.zui.Messager('你有未作答题目，请全部作答后再提交！', zuiMessager.fail).show();
            return;
        }
        $.ajax({
            type: 'POST',
            url: serverUrl + 'exams/item/' + examId + '/' + userId ,
            data: {
                type : gz.global.type_self_evaluation,
                paperId: pref,
                answer : JSON.stringify(answer)
            },
            async: true,
            beforeSend: $.beforeSend,
            success: function (data) {
                if (data['status'] == 200) {
                    window.location.href = "user-exam.html?examId=" + examId;
                } else {
                    new $.zui.Messager('提交自我评价失败', zuiMessager.fail).show();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                gz.logger(textStatus);
                gz.logger(errorThrown);
                new $.zui.Messager('提交自我评价失败', zuiMessager.fail).show();
            }
        });
        
        
    }
    </script>
</body>
</html>

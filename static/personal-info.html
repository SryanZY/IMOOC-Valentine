<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>用户信息</title>
<!-- css文件 放头部-->
<link rel="stylesheet" type="text/css" href="css/style.css" />

<!-- 引入共有的css -->
<script src="js/style.js"></script>
<style>
    #personal-info-main{
        border: 2px solid #4CAF54;
        margin-bottom: 20px;
    }
    
    #personal-info-main table{
        margin-bottom: 0px;
        font-size: 16px;
    }
    
    #personal-info-main td{
        height: 50px;
        line-height: 50px;
    }
    
    .list-title{
        width: 100px;
    }
    
    #personal-info-main table input{
        width: 230px;
        height: 40px;
    }
    
    #personal-info-main select{
        width: 230px;
        height: 40px;
        margin-top: 5px;
    }
    
    #update-passwd{
        width: 30%;
        text-align: right;
    }
    
    #update-passwd input{
        margin-left: 20px;
    }
    
    #update-passwd .row{
        margin-top: 10px;
        margin-bottom: 10px;
        font-size: 16px;
    }
</style>
</head>
<body>
    <div id="main">
        <div id="personal-info-header" style="margin-bottom: 15px;">
            <ul class="nav nav-pills">
                <li id="personal-info-tab" onclick="showInfo('personal-info-template')"><a>个人信息</a></li>
                <li id="update-passwd-tab"><a onclick="showInfo('update-passwd-template')">修改密码</a></li>
            </ul>
        </div>
        <div id="personal-info-main"></div>
        <div id="submit-btn">
            <button type="button" class="btn btn-primary" onclick="savePersonalInfo()">确认修改</button>
        </div>
        <div id="clazzes-info-main" class="hidden">
            <hr/>
            <div id="clazz-info-heading" style="text-align: center; margin-bottom: 20px;">
                <h3>班级信息列表</h3>
            </div>
            <div id="clazz-nav" style="margin-bottom: 15px;">
                <ul class="nav nav-pills">
                    <li id="current-clazz-tab" onclick="getClazzList('current-clazz-tab')"><a>当前班级</a></li>
                    <li id="invalid-clazz-tab"><a onclick="getClazzList('invalid-clazz-tab')">历史班级</a></li>
                </ul>
            </div>
            <div id="clazz-info-body"></div>
            <div id="warn" style="text-align: center"></div>
        </div>
    </div>
    
    <!-- js文件放底部 -->
    <!-- 共有的js引用commos.js -->
    <script src="js/common.js"></script>
    <!--  各个页面单独用的js 各自引入-->
    <script type="text/javascript">
        var userId = $.cookie(cookieUserIdKey);
        var role = $.cookie(cookieUserRoleKey);
        var user;
        
        $(function(){
            getPersonalInfo();
        });
        
        template.helper('turnTime', turnTime);
        
        /*截取yyyy-mm-dd*/
        function turnTime(timestamp) {
            var result = turnDate(timestamp);
            if(result != ''){
                return result.split(" ")[0];
            }else {
                return '';
            }
        }
        
        function getPersonalInfo() {
            $.ajax({
                type: 'GET',
                url: serverUrl + 'users/' + userId,
                async: true,
                beforeSend: $.beforeSend,
                success: function (data) {
                    if (data['status'] < 400) {
                        user = data['data'];
                        if($("#update-passwd-tab").hasClass("active")) { //在修改密码tab
                            showInfo('update-passwd-template');
                        }else { //首次登录或在修改个人信息tab
                            showInfo('personal-info-template')
                            //初始化
                            init();
                        }
                    } else {
                        new $.zui.Messager('获取用户信息失败', zuiMessager.fail).show();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
        
        function showInfo(templateId) {
            if(templateId === 'update-passwd-template') {
                $("#update-passwd-tab").addClass("active");
                $("#personal-info-tab").removeClass("active");
                $('#personal-info-main').html(template(templateId));
                
                $('#clazzes-info-main').addClass('hidden');
            }else {
                $("#personal-info-tab").addClass("active");
                $("#update-passwd-tab").removeClass("active");
                $('#personal-info-main').html(template(templateId, {'user': user}));
                
                if(role == Role.Student.key) {
                    $('#clazzes-info-main').removeClass('hidden');
                    getClazzList('current-clazz-tab');
                }
                
                init(); //性别/民族 需要重新初始化，填充值
                
                <!--选择日期-->
                $(".personal-info-form-date").datetimepicker({
                    language:  "zh-CN",
                    weekStart: 1,
                    todayBtn:  1,
                    autoclose: 1,
                    todayHighlight: 1,
                    startView: 2,
                    minView: 2,
                    forceParse: 0,
                    format: "yyyy-mm-dd"
                })
            }
        }
        
        function savePersonalInfo() {
            var dataMap;
            if($("#personal-info-tab").hasClass("active")) { //在修改个人信息tab
                var sexValue = $("#sex option:selected").val();
                
                var email = $("#email").val();
                var emailReg=/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
                if(!emailReg.test($.trim(email)) && $.trim(email) != ''){ //邮箱不为空 && 邮箱格式不正确
                    new $.zui.Messager('邮箱格式不正确', zuiMessager.fail).show();
                    $('#email').focus();
                    return;
                }
                
                var phoneNumber = $("#phoneNumber").val();
                if(!(/^1(3|4|5|7|8)\d{9}$/.test($.trim(phoneNumber))) && $.trim(phoneNumber) != ''){ //手机号不为空 && 格式不正确
                    new $.zui.Messager('手机号码有误，请重填！', zuiMessager.fail).show();
                    $("#phoneNumber").focus();
                    return false;
                }
                
                dataMap = {
                        "sex": sexValue,
                        "birthday": $("#birthday").val(),
                        "nation": $("#national option:selected").val(),
                        "major": $("#major").val(),
                        "phoneNumber": phoneNumber,
                        "email": email
                    }
            } else { //在修改密码tab中
                var oldPasswd = $("#old-passwd").val();
                var newPasswd = $("#new-passwd").val();
                var confirmPasswd = $("#confirm-passwd").val();
                
                if (!$.trim(oldPasswd)) {
                    new $.zui.Messager('请填写您的原密码', zuiMessager.fail).show();
                    $('#old-passwd').focus();
                    return;
                }
                if (!$.trim(newPasswd)) {
                    new $.zui.Messager('请填写您的新密码', zuiMessager.fail).show();
                    $('#new-passwd').focus();
                    return;
                }
                if (!$.trim(confirmPasswd)) {
                    new $.zui.Messager('请填写确认的新密码', zuiMessager.fail).show();
                    $('#confirm-passwd').focus();
                    return;
                }
                
                if($.md5(oldPasswd) === user['password']) { //输入的旧密码正确
                    if(newPasswd == confirmPasswd) {
                        dataMap = {
                            'password': $.md5(newPasswd)
                        }
                    } else {
                        new $.zui.Messager('两次输入的密码不一致', zuiMessager.fail).show();
                    }
                } else {
                    new $.zui.Messager('原密码不正确', zuiMessager.fail).show();
                    $('#old-passwd').focus();
                    return;
                }
            }
           
            $.ajax({
                type: 'PUT',
                url: serverUrl + 'users/' + userId,
                async: true,
                data: JSON.stringify(dataMap),
                contentType:"application/json",
                dataType: 'json',
                beforeSend: $.beforeSend,
                success: function (data) {
                    if (data['status'] < 400) {
                        new $.zui.Messager('修改成功',zuiMessager.success ).show();
                        getPersonalInfo();
                    } else {
                        new $.zui.Messager('修改失败', zuiMessager.fail).show();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
        
        function init(){
            //初始化民族下拉列表
            var nations = ["汉族","蒙古族","回族","藏族","维吾尔族","苗族","彝族","壮族","布依族","朝鲜族","满族","侗族","瑶族","白族","土家族",
                           "哈尼族","哈萨克族","傣族","黎族","傈僳族","佤族","畲族","高山族","拉祜族","水族","东乡族","纳西族","景颇族","柯尔克孜族",
                           "土族","达斡尔族","仫佬族","羌族","布朗族","撒拉族","毛南族","仡佬族","锡伯族","阿昌族","普米族","塔吉克族","怒族", "乌孜别克族",
                            "俄罗斯族","鄂温克族","德昂族","保安族","裕固族","京族","塔塔尔族","独龙族","鄂伦春族","赫哲族","门巴族","珞巴族","基诺族"];
            
            var $nat = document.getElementById ("national");
            for ( var i = 0; i < nations.length; i++) {
                var option = document.createElement ('option');
                option.value = nations[i];
                var txt = document.createTextNode (nations[i]);
                option.appendChild (txt);
                $nat.appendChild (option);
            }
            
          //初始化性别
            $("#sex option").each(function(i) {
                if($(this).val() == user.sex) {
                    $(this).attr("selected",true);
                }
            });
            
            //初始化民族
            $("#national option").each(function(i) {
                if($(this).text() === user.nation) {
                    $(this).attr("selected",true);
                }
            });
        }
        
        //获取学生所在班级列表
        function getClazzList(tab) {
            var url;
            if(tab == 'current-clazz-tab') {
                $('#'+tab).addClass('active');
                $('#invalid-clazz-tab').removeClass('active');
                
                url = serverUrl + 'classes/'+ userId +'/classes?type=0'
            }else if(tab == 'invalid-clazz-tab') {
                $('#'+tab).addClass('active');
                $('#current-clazz-tab').removeClass('active');
                
                url = serverUrl + 'classes/'+ userId +'/classes?type=1'
            }
            
            $.ajax({
                type: 'GET',
                url: url,
                async: true,
                beforeSend: $.beforeSend,
                success: function (data) {
                    if (data['status'] < 400) {
                        var clazzes = data['data'];
                        
                        if(clazzes.length > 0) {
                            $('#clazz-info-body').html(template('clazz-info-template', {'clazzes': clazzes}));
                        }else {
                            $('#warn').html('<img class="nodata" src="image/nodata.png" alt="暂无数据" title="暂无数据">');
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
    </script>
    
    <script id="personal-info-template" type="text/html">
        <div id="personal-info">
            <table class="table">
                <tbody>
                    <tr>
                        <td class="list-title"><span>姓&nbsp;&nbsp;名：</span></td>
                        <td >{{user.name}}</td>
                        <td class="list-title"><span>ID：</span></td>
                        <td >{{user.userId}}</td>
                        <td class="list-title"><span>年&nbsp;&nbsp;级：</span></td>
                        <td >{{user.realGrade}}</td>
                    </tr>
                    <tr>
                        <td class="list-title"><span>班&nbsp;&nbsp;级：</span></td>
                        <td >{{user.realClass}}</td>
                        <td class="list-title">性&nbsp;&nbsp;别：</td>
                        <td >
                            <select id="sex" class="form-control">
                                <option value="">请选择</option>
                                <option value="1">女</option>
                                <option value="2">男</option>
                            </select>
                        </td>
                        <td class="list-title"><span>出生日期：</span></td>
                        <td >
                            <input type="text" id="birthday" class="personal-info-form-date" readonly="readonly" value="{{turnTime(user.birthday)}}"/>
                        </td>
                    </tr>
                    <tr>
                        <td class="list-title"><span>民&nbsp;&nbsp;族：</span></td>
                        <td >
                            <select id="national" name="nation" class="form-control">
                                <option value="">请选择</option>
                            </select>
                        </td>
                        <td class="list-title"><span>专&nbsp;&nbsp;业：</span></td>
                        <td ><input type="text" id="major" value="{{user.major}}"/></td>
                        <td class="list-title"><span>手&nbsp;机&nbsp;号：</span></td>
                        <td ><input type="text" id="phoneNumber" value="{{user.phoneNumber}}"/></td>
                    </tr>
                    <tr>
                        <td class="list-title"><span>邮&nbsp;&nbsp;箱：</span></td>
                        <td >
                            <input type="text" id="email" value="{{user.email}}"/>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </script>
    
    <script id="update-passwd-template" type="text/html">
        <div id="update-passwd">
            <div class="row">
                <span>原密码&nbsp;&nbsp;&nbsp;&nbsp;</span><input id="old-passwd" type="password"></input>
            </div>
            <div class="row">
                <span>新密码&nbsp;&nbsp;&nbsp;&nbsp</span><input id="new-passwd" type="password"></input>
            </div>
            <div class="row">
                <span>确认密码</span><input id="confirm-passwd" type="password"></input>
            </div>
        </div>
    </script>
    
    <script id="clazz-info-template" type="text/html">
        {{each clazzes as clazz}}
            <div class="clazz-info col-sm-3">
                {{if clazz.is_overdue == '1'}}
                    <div class="panel panel-default">
                {{else}}
                    <div class="panel panel-primary">
                {{/if}}
                    <div class="panel-heading">
                        {{clazz.classname}} ({{clazz.grade}})
                    </div>
                    <div class="panel-body">
                        <div>
                            <span>授权码：{{clazz.code}}</span>
                        </div>
                        <div>
                            <span>班级教师：{{clazz.teachername}}</span>
                        </div>
                        <div>
                            <span>开始日期：{{turnTime(clazz.start_time)}}</span>
                        </div>
                        <div>
                            <span>结束日期：{{turnTime(clazz.end_time)}}</span>
                        </div>
                    </div>
                </div>
            </div>
        {{/each}}
    </script>
</body>
</html>
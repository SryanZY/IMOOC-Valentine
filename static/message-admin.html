<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>消息中心</title>
<!-- css文件 放头部-->
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link href="lib/kindeditor/kindeditor.min.css" type="text/css" rel="stylesheet">

<script src="js/style.js"></script>

<style type="text/css">
    .icon-eye-open:before {
        margin-right: 5px;
    }
</style>

<!-- 引入共有的css -->
</head>
<body>
    <div id="header"></div>
    <div id="main" class="container">
        <div class="col-sm-offset-10 col-sm-2">
            <button class="btn btn-block btn-success" type="button" onclick="showMsgModal(-1);"
                style="margin-top: 20px; margin-bottom: 20px;">发公告</button>
        </div>
            
        <div class="hidden" id="msgs">
            <table id="msgs-table" class="table table-hover" style="text-align: center; table-layout:fixed;" data-func="listMsgs">
                <thead>
                    <tr>
                        <th style="text-align: center; width: 150px;">序号</th>
                        <th style="text-align: center; width: 200px">标题</th>
                        <th style="text-align: center; width: 500px">内容</th>
                        <th style="text-align: center; width: 150px;">发送时间<i class="sort-flag icon icon-sort btn-link" data-sortkey="send_time"></i></th>
                        <th style="text-align: center; width: 150px;">操作</th>
                    </tr>
                </thead>
                <tbody id="msgs-tbody" style="text-align: center;"></tbody>
            </table>
        </div>
                
        <div id="warn" class="hidden">
            <img class="nodata" src="image/nodata.png" alt="暂无数据" title="暂无数据"
                style="margin-left: 35%; margin-top: 50px; margin-bottom: 50px">
        </div>
        
        <div id="kkpager" class="hidden"></div>
    </div>
    <div id="footer" class="text-center"></div>
    
    <!-- 发送公告modal -->
    <div class="modal fade" id="msgModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">×</span><span class="sr-only">关闭</span>
                    </button>
                    <h4 class="modal-title">公告信息</h4>
                </div>
                <div class="modal-body">
                    <div id="msg-box" style="width: 100%; margin-bottom: 20px">
                        <input type="hidden" id="msg-id" value=""/>
                        
                        <div id="msg-theme" style="margin-bottom: 20px;">
                            <span style="font-size: 16px;">主题：</span>
                            <input id="msg-title" type="text" style="width: 90%; min-height: 30px; border-style: none; border-bottom-style: groove"></input>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <span style="font-size: 16px;">重要性：</span>
                            <input type="radio" name="importance" value="1">一般
                            <input type="radio" name="importance" value="2">重要
                            <input type="radio" name="importance" value="3">非常重要
                        </div>
                        <div id="msg-main">
                            <textarea id="msg-content" class="form-control kindeditor" style="width:100%; height:200px; visibility:hidden;">
                            </textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button id="submit" type="button" class="btn btn-primary" onclick="saveMessage('')">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 查看公告modal -->
    <div class="modal fade" id="msgContentModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">×</span><span class="sr-only">关闭</span>
                    </button>
                    <h4 class="modal-title">公告信息</h4>
                </div>
                <div class="modal-body">
                    <div><h4>标题：</h4></div>
                    <div id="msg-review-title" style="margin-top: 20px;"></div>
                    <hr/>
                    <div><h4>内容：</h4></div>
                    <div id="msg-review-content" style="margin-top: 20px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- js文件放底部 -->
    <!-- 共有的js引用commos.js -->
    <script src="js/common.js"></script>
    <!--  各个页面单独用的js 各自引入-->
    <script src="lib/kindeditor/kindeditor.min.js"></script>
    <script src="js/sort_listener_events.js" type="text/javascript"></script>
    <script type="text/javascript">
        var userId = $.cookie(cookieUserIdKey);
        var editor;
        var messages;
        $(function(){
            $('#header').load('header.html');
            $('#footer').load('footer.html');
            
            init();
            listMsgs();
        });
        
        template.helper('turnTime', turnDate);
        
        template.helper('add', function(temp1, temp2){
            return temp1 + temp2;
        });
        
        function init() {
          //初始化副文本编辑器
            KindEditor.ready(function(K) {
                editor = K.create('#msg-content', {
                    basePath: 'lib/kindeditor/',
                    allowFileManager : true,
                    bodyClass : 'article-content',
                    items : [
                             'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline',
                             'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
                             'insertunorderedlist', '|', 'emoticons'],
                    //编辑器失去焦点(blur)时执行的回调函数
                    afterBlur : function() {
                        this.sync();
                    }
                });
            });
        }
        
        function listMsgs(n) {
            var pageNo = 1;
            if(typeof(n) != "undefined" && n != null){
                pageNo = n;
            }
            var pageSize = gz.defaultPageSize;
            var sortKey = $("table#msgs-table").data("sortkey");
            var sortType = $("table#msgs-table").data("sorttype");
            $.ajax({
                type: 'GET',
                url: serverUrl+'messages/admin',
                data: {
                    'sortKey': sortKey,
                    'sortType': sortType,
                    'pageNo': pageNo,
                    'pageSize': pageSize
                },
                dataType: "json",
                contentType:"application/json",
                async: true,
                beforeSend: $.beforeSend,
                success: function (data) {
                    if (data['status'] < 400) {
                        messages = data['data']['messages'];
                        
                        $('#msgs').removeClass('hidden');
                        $("#kkpager").removeClass('hidden');
                        $('#warn').addClass('hidden');
                        $('#msgs-tbody').html(template('msgs-template', {'messages': messages, 'baseIndex': (pageNo-1)*pageSize+1}));
                        
                        //分页控件
                        var totalRecords = data['data']['count'];
                        initPage(pageNo, totalRecords, pageSize, listMsgs);
                    }else {
                        $('#msgs').addClass('hidden');
                        $("#kkpager").addClass('hidden');
                        $('#warn').removeClass('hidden');
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    window.console.log(textStatus);
                    window.console.log(errorThrown);
                }
            });
        }
        
        function showMsgModal(index) {
            if(index == -1){ //发送公告
                $('#msg-id').val('');
                $('#msg-title').val('');
                $("input[name=importance]").each(function() {
                    $(this).prop('checked',false);
                });
                editor.html('');
            }else { //修改公告
                var message = messages[index];
                $('#msg-id').val(message['messageId']);
                $('#msg-title').val(message['title']);
                $("input[value="+message['importance']+"]").prop('checked', 'checked');
                editor.html(message['msgContent']);
            }
            $('#msgModal').modal('show');
        }
        
        /*查看消息具体内容*/
        function showMsgContent(index) {
            $('#msg-review-title').html(messages[index]['title']);
            $('#msg-review-content').html(messages[index]['msgContent']);
            $('#msgContentModal').modal('show');
        }
        
        function saveMessage() {
            var title = $('#msg-title').val();
            var content = editor.html();
            var sendType = 3; //公告
            var importance = $('input[name=importance]:radio:checked').val(); //重要性
            
            if (!$.trim(content)) {
                new $.zui.Messager('请填写消息内容', zuiMessager.fail).show();
                return;
            }
            
            var dataMap = {
                senderId: userId,
                title : title,
                msgContent : content,
                sendType: sendType,
                importance: importance,
            }
            
            if (!$('#msg-id').val()) {
                typeParam = 'POST';
                urlParam = serverUrl + 'messages';
                pageNo = 1;
            } else {
                typeParam = 'PUT';
                urlParam = serverUrl + 'messages/'+ $('#msg-id').val();
                pageNo = kkpager.pno; ///更新数据后刷新当前页
            }
            
            $.ajax({
                type: typeParam,
                url: urlParam,
                data: JSON.stringify(dataMap),
                contentType:"application/json",
                dataType: 'json',
                async: true,
                beforeSend: $.beforeSend,
                success: function (data) {
                    if (data['status'] < 400) {
                        $('#msgModal').modal('hide');
                        new $.zui.Messager('消息保存成功',zuiMessager.success ).show();
                        listMsgs(pageNo);
                    } else {
                        new $.zui.Messager('消息保存失败', zuiMessager.fail).show();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    gz.logger(textStatus);
                    gz.logger(errorThrown);
                }
            });
        }
        
        function delMsg(msgId) {
            bootbox.confirm('确定删除该消息？', function(result){
                if(result) {
                    var dataMap = {
                        'isDelete': '1'
                    }
                    $.ajax({
                        type: 'PUT',
                        url: serverUrl + 'messages/'+ msgId,
                        data: JSON.stringify(dataMap),
                        contentType:"application/json",
                        dataType: 'json',
                        async: true,
                        beforeSend: $.beforeSend,
                        success: function (data) {
                            if (data['status'] < 400) {
                                new $.zui.Messager('删除消息成功',zuiMessager.success ).show();
                                listMsgs();
                            } else {
                                new $.zui.Messager('删除消息失败', zuiMessager.success).show();
                            }
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            gz.logger(textStatus);
                            gz.logger(errorThrown);
                        }
                    });
                }
            });
        }
    </script>
    
    <script id="msgs-template" type="text/html">
        {{each messages as message index}}
            <tr>
                <td style="vertical-align: middle">{{add(baseIndex,index)}}</td>
                <td style="vertical-align: middle"><p class="text-ellipsis">{{message.title}}</p></td>
                <td style="vertical-align: middle"><p class="text-ellipsis">{{#message.msgContent}}</p></td>
                <td style="vertical-align: middle">{{turnTime(message.sendTime)}}</td>
                <td style="vertical-align: middle">
                    <a href="javascript:showMsgContent('{{index}}')" alt="预览" title="预览"><i class="icon icon-eye-open"></i></a>
                    <a href="javascript:showMsgModal('{{index}}');" alt="修改" title="修改"><i class="icon-edit"></i></a>
                    &nbsp;<a href="javascript:delMsg('{{message.messageId}}');" alt="删除" title="删除"><i class="icon-remove"></i></a>
                </td>
            </tr>
        {{/each}}
     </script>
</body>
</html>
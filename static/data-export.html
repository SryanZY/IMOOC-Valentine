<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hello world!</title>
<!-- css文件 放头部-->
<link rel="stylesheet" type="text/css" href="css/style.css" />

<!-- 引入共有的css -->
<script src="js/style.js"></script>
<style type="text/css">
/* select */
.select{width: 70%;margin: 50px auto 20px auto;}
.select .select-list{border-bottom:#eee 1px dashed;padding: 5px;}
.select span.title,.select div.options span{text-align:left;line-height:24px;float:left;display:inline;margin:5px;padding: 0 5px;}
.select span.title{text-align:right;font-weight: bold;}
.select div.options span:hover{color:#43a047;background-color:#f3edc2}
.select div.options span.selected{color:#fff;background-color:#43a047}
</style>
</head>
<body>
    <div id="header"></div>
    <div id="main">
       <div class="container" style="min-height: 500px;">
           <div class="select">
              <div class="select-list row" id="year">
                   <span class="col-sm-2 title"><i class="icon icon-time"></i> 学期:</span>
                   <div class="col-sm-9" style="margin: 3px 10px;">
                        <select id="yearSelect" name="year" style="width: 100%;"></select>
                   </div>
              </div>
              <div class="select-list row" id="school">
                   <span class="col-sm-2 title"><i class="icon icon-home"></i> 学校:</span>
                   <div class="col-sm-9 options"></div>
              </div>
              <div class="select-list row" id="grade">
                   <span class="col-sm-2 title"><i class="icon icon-paper-clip"></i> 年级:</span>
                   <div class="col-sm-9 options"></div>
              </div>
              <div class="select-list row" id="paper">
                   <span class="col-sm-2 title"><i class="icon icon-picture"></i> 试卷:</span>
                   <div class="col-sm-9 options"></div>
              </div>
          </div>
          <div style="width: 70%;margin: 0 auto;text-align: center;padding: 20px;">
              <button class="btn btn-primary" type="button" onclick="downloadExcel();"><i class="icon icon-cloud-download"></i> 下载Excel文件</button>
          </div>
       </div>
    </div>
    <div id="footer" class="text-center"></div>

    <!-- js文件放底部 -->
    <!-- 共有的js引用commos.js -->
    <script src="js/common.js"></script>
    <!--  各个页面单独用的js 各自引入-->
    <script type="text/javascript">
    var role = $.cookie(cookieUserRoleKey);
    $(function(){
        $('#header').load('header.html');
        $('#footer').load('footer.html');
        
        $(document).on('click','.select .select-list .options span.dd',function () {
            var inputObj = $(this).find("input")[0];
            if(inputObj.checked){
                inputObj.checked = false;
                $(this).removeClass("selected");
            }else{
                $(this).addClass("selected");
                inputObj.checked = true;
            }
        });
        
        $(document).on('click','.select .select-list .options input',function () {
            var inputObj = $(this)[0];
            if(inputObj.checked){
                inputObj.checked = false;
            }else{
                inputObj.checked = true;
            }
        });
        
        getYearSelectList();
        getGradeSelectList();
        getPaperSelectList();
        if(role === Role.Admin.key){
            $('#school').show();
            getSchoolSelectList();
        }else{
            $('#school').hide();
        }
    });
    
    <!--学校列表-->
    getSchoolSelectList = function(){
        $.ajax({
            type: 'GET',
            url: serverUrl + 'lists/schools',
            async: true,
            beforeSend: $.beforeSend,
            success: function (data) {
                if (data['status'] < 400) {
                   $.each(data['data'], function(i, n){
                       $(".select #school div.options").append('<span class="dd"><input type="checkbox" name="schoolCheckBox" value="'+n.id+'">'+n.name+"("+n.id+")"+'</span>');
                   });
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                gz.logger(textStatus);
                gz.logger(errorThrown);
            }
        });
    }
    
    <!--学期列表-->
    getYearSelectList = function(){
        var selec = $("#yearSelect");
        selec.empty();
        selec.append("<option value=''></option>");
        //设置年份的选择 
        var myDate= new Date();
        var curYear = myDate.getFullYear();
        var curMonth = myDate.getMonth();
        var startYear = curYear-3;//起始年份 
        var endYear = curYear+3;//结束年份 
        for (var i=startYear;i<=endYear;i++){
            var firstRange = (i-1)+"-"+gz.semester.first.begin+"~"+i+"-"+gz.semester.first.end;
            var secondRange = i+"-"+gz.semester.second.begin+"~"+i+"-"+gz.semester.second.end;
            selec.append("<option value='"+firstRange+"'>"+i+"学年第一学期("+firstRange+")</option>");
            selec.append("<option value='"+secondRange+"'>"+i+"学年第二学期("+secondRange+")</option>");
        }
        var dataRange;
        if(curMonth>=3 && curMonth<=8){
            dataRange = curYear+"-"+gz.semester.second.begin+"~"+curYear+"-"+gz.semester.second.end;
        }else{
            dataRange = (curYear-1)+"-"+gz.semester.first.begin+"~"+curYear+"-"+gz.semester.first.end;
        }
        selec.find("option[value = '"+dataRange+"']").attr("selected","selected");
        $(selec).chosen({
            allow_single_deselect:true,//设置为 true 时非必选的单选框会显示清除选中项图标
            placeholder_text:'选择时间范围……',//单选框没有选中项时显示的占位文字
            no_results_text: '没有找到',    // 没有搜索到匹配项时显示的文字
            disable_search_threshold: 0, //  少于 n 项时隐藏搜索框
            search_contains: true  // 从任意位置开始检索
        });
    }
    
    <!--年级列表-->
    getGradeSelectList = function(){
      //设置年份的选择 
        var myDate= new Date();
        var curYear = myDate.getFullYear();
        var curMonth = myDate.getMonth();
        var startYear = curYear-3;//起始年份 
        var endYear = curYear+3;//结束年份 
        for (var i=startYear;i<=endYear;i++){
            $(".select #grade div.options").append('<span class="dd"><input type="checkbox" name="gradeCheckBox" value="'+i+'">'+i+'</span>');
        }
    } 
    <!--试卷列表-->
    getPaperSelectList = function(){
        $.ajax({
            type: 'GET',
            url: serverUrl + 'lists/papers',
            async: true,
            beforeSend: $.beforeSend,
            success: function (data) {
                if (data['status'] < 400) {
                   $.each(data['data'], function(i, n){
                       $(".select #paper div.options").append('<span class="dd"><input type="checkbox" name="paperCheckBox" value="'+n.id+'">'+n.name+'</span>');
                   });
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                gz.logger(textStatus);
                gz.logger(errorThrown);
            }
        });
    }
    
    //下载excel文件
    function downloadExcel(fileName,type){
        var schoolIds = [];
        var grades = [];
        var paperIds = [];
        var dateRange = $.trim($('#yearSelect option:selected').val());
        if (dateRange=="") {
            new $.zui.Messager('请选择学期！', zuiMessager.fail).show();
            return;
        }
        
        if(role === Role.Admin.key){
            $('input[name="schoolCheckBox"]:checked').each(function(){ 
                schoolIds.push($(this).val()); 
            });
            if (schoolIds.length==0) {
                new $.zui.Messager('请选择学校！', zuiMessager.fail).show();
                return;
            }
        }else{
            var schoolId = $.cookie(cookieSchoolIdKey);
            schoolIds.push(schoolId); 
        }
        
        $('input[name="gradeCheckBox"]:checked').each(function(){ 
            grades.push($(this).val()); 
        });
        if (grades.length==0) {
            new $.zui.Messager('请选择年级！', zuiMessager.fail).show();
            return;
        }
        $('input[name="paperCheckBox"]:checked').each(function(){ 
            paperIds.push($(this).val()); 
        });
        if (paperIds.length==0) {
            new $.zui.Messager('请选择试卷！', zuiMessager.fail).show();
            return;
        }
        
        window.location = serverUrl + "answers/download?"
                + "userId="+$.cookie(cookieUserIdKey)
                + "&token="+$.cookie(cookieTokenKey)
                + "&paperIds="+ JSON.stringify(paperIds)
                + "&schoolIds=" + JSON.stringify(schoolIds)
                + "&grades=" + JSON.stringify(grades)
                + "&dateRange=" + dateRange;
    }
    
    </script>
</body>
</html>
